/*! CEDEK 2015-02-08 */
function createPaymentChange(a,b,c,d,e,f){"use strict";return function(){b.payment=null,b.paymentType=a,$(d).find("input").attr("type",f)}}function refreshStudentsWithPendingPaymentsCB(a,b,c){"use strict";return function(){a.$emit("paymentsUpdated",b,c)}}function registerPayment(a,b){"use strict";return function(){return 2===a.data.paymentType?b.makePayment(a.student,a.course,a.data.payment,a.amount,refreshStudentsWithPendingPaymentsCB(a,a.course,a.student)):3===a.data.paymentType?b.payLater(a.student,a.course,a.amount,a.charge,a.data.payment,refreshStudentsWithPendingPaymentsCB(a,a.course,a.student)):void 0}}function isInputEnabled(a){"use strict";return function(){return 2===a.paymentType||3===a.paymentType}}angular.module("CEDEK",["ngResource","ngSanitize","ngRoute","templates"]).config(["$routeProvider",function(a){"use strict";a.when("/personas/agregar",{templateUrl:"persona/agregar.html",controller:"PeopleCtrl",roles:["Administrador"]}),a.when("/personas/listar",{templateUrl:"persona/listar.html",controller:"PeopleCtrl",roles:["Administrador","Regular"]}),a.when("/persona/editar/:personId",{templateUrl:"persona/agregar.html",controller:"PeopleCtrl",roles:["Administrador","Regular"]}),a.when("/cursos/listar",{templateUrl:"curso/listar.html",controller:"CourseCtrl",roles:["Administrador","Regular"]}),a.when("/cursos/agregar",{templateUrl:"curso/agregar.html",controller:"CourseCtrl",roles:["Administrador"]}),a.when("/curso/:courseId",{templateUrl:"curso/detalles.html",controller:"CourseCtrl",roles:["Administrador","Regular"]}),a.when("/curso/editar/:courseId",{templateUrl:"curso/agregar.html",controller:"CourseCtrl",roles:["Administrador"]}),a.when("/usuarios/listar",{templateUrl:"usuario/listar.html",controller:"UserCtrl",roles:["Administrador"]}),a.when("/usuarios/agregar",{templateUrl:"usuario/agregar.html",controller:"UserCtrl",roles:["Administrador"]}),a.when("/usuario/editar/:userId",{templateUrl:"usuario/agregar.html",controller:"UserCtrl",roles:["Administrador","Regular"]}),a.when("/admin/eventos",{templateUrl:"admin/eventos.html",controller:"AdminCtrl",roles:["Administrador"]}),a.when("/admin/consultas",{templateUrl:"admin/consulta.html",controller:"AdminCtrl",roles:["Administrador"]}),a.when("/consulta/nueva/:personId",{templateUrl:"consulta/agregar.html",controller:"UserCtrl",roles:["Administrador","Regular"]}),a.when("/login",{templateUrl:"login.html",roles:["Administrador","Regular"]}),a.when("/dashboard",{templateUrl:"dashboard.html",controller:"DashboardCtrl",roles:["Administrador","Regular"]}),a.otherwise({redirectTo:"/dashboard"})}]);var app=angular.module("CEDEK");app.controller("RootCtrl",["$scope","$route","$location","AuthService","UserService",function(a,b,c,d,e){"use strict";a.currentUser=null,a.redirectAfterLogin=null,a.login={username:"",password:""},a.showFilter=!0,a.alerts={confirmRemoveStudentFromCourse:{name:"_none_"},confirmDeleteScholarship:{name:"_none_"},confirmDebtClose:{amount:0,name:"_none_"}},a.login=function(){d.login(a.login.username,a.login.password,function(b){a.currentUser=b,c.path(a.redirectAfterLogin)},function(b){a.notify(b.data,"error")})},a.notify=function(a,b){$.notify(a,{globalPosition:"top center",autoHideDelay:2e3,className:b})},a.getInputClass=function(b,c){var d=[].concat(c);return a.isInputInvalid(b)&&(d.push("has-feedback"),d.push("has-error")),d},a.isInputInvalid=function(a){return a.$invalid&&a.$dirty},a.getLoggedUser=function(){return a.currentUser},a.isLogged=function(){return null!==a.currentUser},a.toggleLatePaymentOptions=function(a){var b=$("#latePaymentOption"+a);"none"===b.css("display")?b.css("display",""):b.css("display","none")},a.getAge=function(a){return a?(new Date).getFullYear()-parseInt(a.split("-")[0]):0},a.today=function(){var a=new Date,b=a.getMonth()+1,c=a.getDate();return a.getFullYear()+"-"+(10>b?"0"+b:b)+"-"+(10>c?"0"+c:c)},a.getDateLabel=function(a,b){if(null==a)return"";var c=a.split("-"),d=parseInt(c[0]),e=parseInt(c[1])-1,f=parseInt(c[2]),g=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][e];return b?f+" "+g.substring(0,3)+" "+d:f+" de "+g+"  "+d},a.$on("userUpdated",function(b,c){a.currentUser=e.get(c)}),a.$on("$locationChangeStart",function(d,e){var f=e.substring(e.indexOf("#")+1);for(var g in b.routes){var h=b.routes[g];if(null!==f.match(h.regexp)&&"null"!==g)if(a.isLogged())h&&h.roles.indexOf(a.getLoggedUser().user_type_name)<0&&(a.notify("No tienes autorizacion para entrar ahi","error"),c.path("/dashboard"));else{if(null===e.match(/login$/)){var i=e.substring(e.indexOf("#")+1);a.redirectAfterLogin=i}c.path("/login")}}}),a.$on("$routeChangeSuccess",function(){a.name="";var c=b.current.originalPath;a.showFilter=void 0!==c&&(c.match("listar$")||c.match("^/curso/:courseId$"))?!0:!1})}]),app.controller("DashboardCtrl",["$scope","PeopleService","CourseService",function(a,b,c){"use strict";a.todayCourses=null,a.comingCourses=null,a.todayBirthdays=null,a.activeCourses=null,a.initDashboard=function(){a.comingCourses=c.getComingCourses(),a.activeCourses=c.getActiveCourses(),c.getTodayCourses(function(b){b.forEach(function(a){a.scheduleTime=a.hour.substring(11,16)}),a.todayCourses=b}),b.birthdaysToday(function(b){b.forEach(function(b){b.age=a.getAge(b.birthday)}),a.todayBirthdays=b})}}]),angular.module("CEDEK").controller("CourseCtrl",["$scope","$routeParams","$location","PeopleService","CourseService","DebtService","ScholarshipService",function(a,b,c,d,e,f,g){"use strict";function h(b){b.forEach(function(b){b.label=a.getDateLabel(b.session_date)})}function i(b,c){var d=a.courses.filter(function(a){return a.id===b})[0];a.panels[c].courseName=d.name,a.panels[c].courseId=d.id}if(a.course=null,a.courses=null,a.panels={students:{courseId:0,courseName:"",show:!1},attendance:{courseId:0,courseName:"",show:!1,sessionDate:null,sessions:[],getSessions:function(b){return e.getCourseSessions(b,function(b){h(b),a.panels.attendance.sessions=b})},attendanceToday:[]},courseStudent:{student:null,getStudent:function(b,c){d.getCourseStudent(b,c,function(b){h(b.unattendance),a.panels.courseStudent.student=b})}},payment:{students:null},scholarship:{studentId:null,courseId:null,amount:0,students:null,studentsWithNoScholarship:null},subscribe:{studentId:"",studentList:[],fullStudentList:[],sync:function(b){a.panels.subscribe.studentList=a.panels.subscribe.fullStudentList.filter(function(a){return 0===b.filter(function(b){return a.id===b.id}).length})}}},a.giveScholarship=function(b){e.giveScholarship(b,a.panels.scholarship.studentId,a.panels.scholarship.amount,function(){a.getStudentsWithScholarship(b)})},a.subscribe=function(b,c){e.subscribeStudent(b,c),a.$emit("enrollmentUpdated",b)},a.thereAreSessionToday=function(a){return a===(new Date).getDay()},a.checkAttendance=function(b,c){e.checkAttendance(b,c,a.today(),function(){a.$broadcast("attendanceUpdated",b,c,a.today(),a.panels.attendance.sessionDate)})},a.isCreatingCourse=function(){return null==a.panels.scholarship.students},a.create=function(b){e.createCourse(b,function(d){c.path("/curso/editar/"+d.id),a.notify(b.name+" agregado!","success")})},a.goToDetails=function(a){c.path("/curso/"+a)},a.update=function(b,c){return e.updateCourse(b,c,function(){a.notify("Curso '"+c.name+"' actualizado","success")},function(b){a.notify(b.data,"error")})},a.selectStudent=function(b){a.panels.courseStudent.getStudent(a.course.id,b)},a.toggleViewStudents=function(b){a.panels.students.show&&a.panels.students.courseId===b?a.panels.students.show=!1:(a.panels.students.show=!0,i(b,"students"),a.$emit("enrollmentUpdated",b))},a.toggleViewAttendance=function(b){a.panels.attendance.show&&a.panels.attendance.courseId===b?a.panels.attendance.show=!1:(a.panels.attendance.show=!0,i(b,"attendance"),a.panels.attendance.getSessions(b))},a.hidePaymentOptions=function(a){var b=$("#paymentOption"+a);b.css("display","none")},a.togglePaymentOptions=function(b){var c=$("#paymentOption"+b);"none"===c.css("display")?c.css("display",""):a.hidePaymentOptions(b)},a.getStudentsWithPendingPayments=function(b){d.getCourseDebts(b,function(b){b.forEach(function(b){b.commitmentLabel=a.getDateLabel(b.commitment)}),a.panels.payment.students=b})},a.confirmDebtClose=function(b){var c=a.alerts.confirmDebtClose;c.amount=b.amount,c.name=b.person_name,c.confirm=function(){f.payNow(b.id,function(){a.$emit("paymentsUpdated",b.course_id,b.person_id),$("#confirmCloseDebt").modal("hide")},function(){console.log("Error processing the payment.")})}},a.getStudentsWithScholarship=function(b){d.getCourseScholarships(b,function(c){a.panels.scholarship.courseId=b,a.panels.scholarship.students=c})},a.initCourseList=function(){e.getCourses(function(b){b.forEach(function(b){b.beginLabel=a.getDateLabel(b.begin),b.endLabel=a.getDateLabel(b.end)}),a.courses=b})},a.attendToday=function(b){return a.panels.attendance.attendanceToday.filter(function(a){return a.id===b&&a.attend}).length>0},a.$on("removeStudentFromCourse",function(b,c,d,f){var g=a.alerts.confirmRemoveStudentFromCourse;g.name=f,g.confirm=function(){e.unrollStudent(c,d,function(){a.$emit("enrollmentUpdated",c),$("#confirmRemoveStudentFromCourse").modal("hide")},function(){console.log("Error processing the unrollment."),$("#confirmRemoveStudentFromCourse").modal("hide")})}}),a.$on("enrollmentUpdated",function(b,c){d.getStudentsFromCourse(c,function(b){a.course.students=b,a.panels.students.studentsList=b,a.panels.subscribe.sync(b)})}),a.$on("deleteScholarship",function(b,c,d,e){var f=a.alerts.confirmDeleteScholarship;f.name=e,f.confirm=function(){g.revoke(c,function(){a.getStudentsWithScholarship(d),$("#confirmDeleteScholarship").modal("hide")},function(){console.log("Error processing the scholarship revocation."),$("#confirmDeleteScholarship").modal("hide")})},a.$apply(a.alerts.confirmDeleteScholarship)}),a.$on("attendanceDateUpdated",function(b,c,d){a.panels.attendance.sessionDate=d}),a.$on("attendanceUpdated",function(b,c,d,f){var g=a.panels.attendance.sessions.filter(function(a){return a.session_date===f});0===g.length&&(a.panels.attendance.getSessions(c),a.panels.attendance.attendanceToday=e.getAttendance(c,f)),a.panels.attendance.attendanceToday.forEach(function(a){return a.id===d&&(a.attend=!0),a}),a.selectStudent(d)}),a.$on("paymentsUpdated",function(b,c,d){a.getStudentsWithPendingPayments(c),a.selectStudent(d),b.currentScope.hidePaymentOptions(d)}),b.courseId){var j=parseInt(b.courseId);d.listStudents(function(b){a.panels.subscribe.fullStudentList=b,a.panels.scholarship.studentsWithNoScholarship=b,e.getCourse(j,function(b){a.thereAreSessionToday(b.day)&&(a.panels.attendance.attendanceToday=e.getAttendance(b.id,a.today())),b.cost=parseFloat(b.cost),b.hour=b.hour.substring(11,16),b.beginLabel=a.getDateLabel(b.begin),b.endLabel=a.getDateLabel(b.end),a.course=b,a.panels.subscribe.sync(b.students)})}),a.getStudentsWithScholarship(j),a.getStudentsWithPendingPayments(j),a.panels.attendance.getSessions(j)}else a.course={name:"",code:"",cost:0,begin:"",end:"",day:0,hour:"18:00"}}]),angular.module("CEDEK").controller("UserCtrl",["$scope","$routeParams","$location","UserService","CatalogService","AuthService",function(a,b,c,d,e,f){"use strict";if(a.userTypes=e.userTypes(),a.user=null,a.passwords=null,a.users=null,a.isCreatingUser=function(){return null===c.path().match(/editar/)},a.create=function(b){d.create(b,function(d){a.notify("El usuario '"+b.name+"' fue creado ","success"),c.path("usuario/editar/"+d.id)})},a.update=function(b){d.update(b,a.user,function(){a.$emit("userUpdated",b),a.notify("Datos del usuario actualizados!","success")},function(b){a.notify(b.data,"error")})},a.getUser=function(b){a.user=d.get(b)},a.updatePassword=function(){f.changePassword(a.getLoggedUser().id,a.user.current_password,a.user.new_password,function(){a.notify("Contrase&ntilde;a actualizada!","success")},function(b){a.notify(b.data,"error")})},a.checkPasswords=function(a,b){b.password===b.password_confirm?(a.password_confirm.$invalid=!1,a.$invalid=!a.$valid):(a.password_confirm.$invalid=!0,a.$invalid=!0)},a.initUserList=function(){a.users=d.getUsers()},b.userId){var g=parseInt(b.userId);1===a.getLoggedUser().user_type_id||a.getLoggedUser().id===g?a.getUser(g):(a.notify("No estas autorizado para editar ese usuario","error"),c.path("/dashboard"))}else a.user={username:"",name:"",password:"",password_confirm:"",user_type_id:2}}]),angular.module("CEDEK").controller("PeopleCtrl",["$scope","$routeParams","$location","PeopleService","CourseService","CatalogService",function(a,b,c,d,e,f){"use strict";function g(b){if(null!=a.students){var c=a.students.indexOf(a.students.filter(function(a){return a.id===b.id})[0]);a.students[c]=b}b.debts&&b.debts.forEach(function(b){b.commitmentLabel=a.getDateLabel(b.commitment)})}function h(b){a.student=d.getStudent(b,g)}a.students=null,a.student=null,a.maritalStatus=f.maritalStatus(),a.panels={subscribe:{courses:[]},phone:{isAddingPhone:!1,phoneTypes:f.phoneTypes(),number:"",phone_type_id:1}},a.create=function(b){d.createStudent(b,function(){c.path("personas/listar"),a.notify(b.name+" agregado!","success")})},a.update=function(b){return d.updateStudent(b,a.student,function(){a.notify("Datos de '"+a.student.name+"' actualizados","success")},function(b){a.notify(b.data,"error")})},a.isCreatingPerson=function(){return null==a.student.scholarships},a.hasAcademicHistory=function(){return a.student.enrollments||a.student.reserves||a.student.previous},a.addAnotherPhone=function(){a.panels.phone.number.match(/^[\s]*$/)||a.student.phones.push({number:a.panels.phone.number,phone_type_id:a.panels.phone.phone_type_id}),a.panels.phone.isAddingPhone=!1,a.panels.phone.number=""},a.initStudentList=function(){a.students=d.listStudents(),a.panels.subscribe.courses=e.getOpenCourses()},a.addingPhone=function(){return a.panels.phone.isAddingPhone},a.$on("subscribeStudentToCourse",function(a,b,c){h(c)}),a.$on("paymentsUpdated",function(a,b,c){h(c)}),a.$on("deletePhone",function(b,c,d){a.student.phones=a.student.phones.filter(function(a){return a.number!==c||a.phone_type_id!==d}),a.$apply(a.student)}),b.personId?h(parseInt(b.personId)):a.student={name:"",has_scholarship:!1,scholarship_percentage:"",lead_pray_group:!1,phones:[]}}]),angular.module("CEDEK").controller("ConsultCtrl",["$scope","$routeParams","PeopleService","ConsultService","CatalogService",function(a,b,c,d,e){"use strict";if(a.person=null,a.todayConsult=null,a.lastConsults=null,a.showingAll=!1,a.create=function(b){d.save(a.todayConsult,b,function(){var c=angular.copy(a.todayConsult);c.opts=c.drops,a.lastConsults.unshift(c),d.cleanPacientConsult(b),a.todayConsult=d.getCurrentConsult(b,a.today())})},a.loadAll=function(){d.getAllConsults(f,function(b){a.lastConsults=b,a.showingAll=!0})},a.isStudent=function(a){return a.previous&&a.reserves&&a.enrollments&&(a.previous.length>0||a.reserves.length>0||a.enrollments.length>0)?"Si":"No"},b.personId){var f=parseInt(b.personId);a.person=c.getStudent(f),a.leaders=e.leaders(),a.lastConsults=d.getLastConsults(f),a.todayConsult=d.getCurrentConsult(f,a.today())}}]),angular.module("CEDEK").controller("AdminCtrl",["$scope","$routeParams","$sce","$filter","AdminService","PagerService","PeopleService","ConsultService","CatalogService",function(a,b,c,d,e,f,g,h,i){"use strict";a.panels={consults:{person:null,todayConsult:null,lastConsults:null},events:{list:[],since:null,to:null,currentPage:1,maxPage:50,maxEvents:0,pagerSlots:5,totalPages:function(){return Math.ceil(this.maxEvents/this.maxPage)},hasNext:function(){return this.currentPage<this.totalPages()},hasPrev:function(){return this.currentPage>1},getPages:function(){var a,b=(this.totalPages(),[]);if(this.currentPage<this.pagerSlots/2)for(a=1;a<=this.pagerSlots;a++)a<=this.totalPages()&&b.push(a);else if(this.currentPage+this.pagerSlots/2>=this.totalPages())for(a=this.totalPages()-this.pagerSlots;a<=this.totalPages();a++)a>0&&b.push(a);else for(a=1;a<=this.pagerSlots;a++){var c=this.currentPage-Math.ceil(this.pagerSlots/2)+a;b.push(c)}return b}}},a.initConsult=function(){a.people=g.listStudents(),a.leaders=i.leaders()},a.initEventList=function(){a.getEvents()},a.createConsult=function(b){h.save(a.panels.consults.todayConsult,b,function(){var c=angular.copy(a.panels.consults.todayConsult);c.opts=c.drops,a.panels.consults.lastConsults.unshift(c),h.cleanPacientConsult(b),a.panels.consults.todayConsult=h.getCurrentConsult(b,a.consultDate)})},a.loadPerson=function(){a.panels.consults.person=g.getStudent(a.personId),a.panels.consults.lastConsults=h.getLastConsults(a.personId),a.panels.consults.todayConsult=h.getCurrentConsult(a.personId,a.consultDate)},a.getEvents=function(){f.getEventsCount(function(b){a.panels.events.maxEvents=b.count}),a.panels.events.list=e.getEvents(a.panels.events.currentPage,a.panels.events.maxPage,function(b){a.panels.events.since=d("shortDateFormat")(b[b.length-1].date),a.panels.events.to=d("shortDateFormat")(b[0].date)})},a.getPage=function(b){return b>a.panels.events.totalPages()||0>=b?(console.log(a.panels.events.totalPages()),console.log(b),void a.notify("Pagina invalida","warning")):(a.panels.events.currentPage=b,void a.getEvents())},a.nextPage=function(){a.panels.events.hasNext()&&a.getPage(a.panels.events.currentPage+1)},a.prevPage=function(){a.panels.events.hasPrev()&&a.getPage(a.panels.events.currentPage-1)},a.sanitize=function(a){return c.trustAsHtml(a)}}]),angular.module("CEDEK").filter("shortDateFormat",function(a){"use strict";return function(b){if(null==b)return"";var c=a("date")(new Date(b),"dd MMM yyyy, HH:mm");return c}}),angular.module("CEDEK").filter("dateFormat",function(a){"use strict";return function(b){if(null==b)return"";var c=a("date")(new Date(b),"EEE dd MMM yyyy, HH:mm 'hrs'");return c}});var app=angular.module("CEDEK");app.directive("navigation",function(){"use strict";return{replace:!0,templateUrl:"navigation.html"}}),app.directive("studentList",function(){"use strict";return{replace:!0,scope:{students:"=model",showAttendance:"@showAttendance",course:"=",editable:"@"},templateUrl:"partials/listaEstudiantes.html",link:function(a){a.removeStudentFromCourse=function(b,c,d){a.$emit("removeStudentFromCourse",b,c,d)}}}}),app.directive("courseView",function(){"use strict";return{replace:!0,templateUrl:"partials/vistaCurso.html"}}),app.directive("detailedCourseView",function(){"use strict";return{replace:!0,templateUrl:"partials/vistaDetalladaCurso.html"}}),app.directive("studentListFullOpc",function(){"use strict";return{replace:!0,templateUrl:"partials/listaEstudiantesOpcionesCompletas.html"}}),app.directive("studentView",["DebtService","PeopleService",function(a){"use strict";return{replace:!0,transclude:!0,scope:{student:"=model",canCollapse:"@canCollapse",showAttendance:"@showAttendance",id:"="},templateUrl:"partials/vistaEstudiante.html",link:function(b){b.confirmDebtClose=function(c){var d=b.$parent.alerts.confirmDebtClose;d.amount=c.amount,d.name=c.person_name,d.confirm=function(){a.payNow(c.id,function(){b.$emit("paymentsUpdated",c.course_id,c.person_id),$("#confirmCloseDebt").modal("hide")},function(){console.log("Error processing the payment.")})}}}}}]),app.directive("subscribeCourse",["CourseService",function(a){"use strict";return{replace:!0,scope:{student:"=",courses:"="},templateUrl:"partials/inscribeReservaCurso.html",link:function(b){b.subscribe=function(){var c=a.subscribeStudent(b.courseSelected,b.student.idi);return b.$emit("subscribeStudentToCourse",b.courseSelected,b.student.id),c},b.coursesAvailableForStudent=function(){var a=b.courses.filter(function(a){var c=b.student.enrollments?b.student.enrollments.filter(function(b){return b.id===a.id}):[],d=b.student.reserves?b.student.reserves.filter(function(b){return b.id===a.id}):[];return 0===c.length&&0===d.length});return a}}}}]),app.directive("paymentOptionsCompact",["DebtService",function(a){"use strict";return{replace:!0,scope:{course:"=course",student:"=student",amount:"=amount",charge:"@charge"},link:function(b,c){b.data={payment:null,paymentType:null},b.changeToLaterPayment=createPaymentChange(3,b.data,b.student,c,"paymentSmall","date"),b.changeToPartialPayment=createPaymentChange(2,b.data,b.student,c,"paymentSmall","number"),b.isInputEnabled=isInputEnabled(b.data),b.registerPayment=registerPayment(b,a)},templateUrl:"partials/opcionesPagoCompacto.html"}}]),app.directive("paymentOptions",["DebtService",function(a){"use strict";return{replace:!0,scope:{course:"=course",student:"=student",amount:"=amount",charge:"@charge"},templateUrl:"partials/opcionesPago.html",link:function(b,c){b.data={payment:null,paymentType:null},b.changeToLaterPayment=createPaymentChange(3,b.data,b.student,c,"payment","date"),b.changeToPartialPayment=createPaymentChange(2,b.data,b.student,c,"payment","number"),b.isInputEnabled=isInputEnabled(b.data),b.registerPayment=registerPayment(b,a)}}}]),app.directive("searchAttendance",["CourseService",function(a){"use strict";return{replace:!0,templateUrl:"partials/buscarAsistencia.html",scope:{courseId:"&courseId",sessions:"="},link:function(b){b.attendanceDate="",b.attendance=null,b.$watch("courseId()",function(){b.attendance=[]}),b.getAttendance=function(){return b.attendanceDate.match("^[\\d]{4}-[\\d]{1,2}-[\\d]{1,2}$")?void a.getAttendance(b.courseId(),b.attendanceDate,function(a){b.attendance=a,b.$emit("attendanceDateUpdated",b.courseId(),b.attendanceDate)}):void console.log("Fecha de sesion invalida!")},b.$on("attendanceUpdated",function(a,c,d,e,f){f===e&&b.getAttendance()})}}}]),app.directive("phone",["CatalogService",function(a){"use strict";return{replace:!0,scope:{model:"=",editable:"@"},template:'<span><span><strong>{{model.number}}</strong></span><span class="deletable phone-number label label-default pull-right" style="width: 50px;">{{getPhoneTypeName()}}</span></span>',link:function(b,c){var d=a.phoneTypes();b.getPhoneTypeName=function(){if(d.length<=1)return"";var a=d.filter(function(a){return a.id===b.model.phone_type_id})[0];return void 0===a?"Desconocido":a.name},"true"!==b.editable&&$(c).find(".phone-number").toggleClass("deletable"),$(c).find(".phone-number").hover(function(){"true"===b.editable&&$(this).text("X")}).mouseout(function(){$(this).text(b.getPhoneTypeName())}).click(function(){"true"===b.editable&&b.$emit("deletePhone",b.model.number,b.model.phone_type_id)})}}}]),app.directive("scholarships",[function(){"use strict";return{replace:!0,scope:{scholarships:"=model",editable:"@"},templateUrl:"partials/becas.html"}}]),app.directive("alerts",[function(){"use strict";return{replace:!0,templateUrl:"partials/alertas.html"}}]),app.directive("studentScholarshipPercentage",[function(){"use strict";return{replace:!0,scope:{scholarship:"=",editable:"@"},template:'<li class="list-group-item"><a href="#/persona/editar/{{scholarship.person_id}}">{{scholarship.student_name}}</a><span class="deletable label label-default pull-right wire-label-success" style="width: 50px;"data-toggle="modal" data-target="#confirmDeleteScholarship">{{scholarship.percentage}}%</span></li>',link:function(a,b){if("true"===a.editable)$(b).find(".deletable").hover(function(){$(this).text("X")}).mouseout(function(){$(this).text(a.scholarship.percentage+"%")}).click(function(){a.$emit("deleteScholarship",a.scholarship.id,a.scholarship.course_id,a.scholarship.student_name)});else{var c=$(b).find(".deletable");c.attr("data-toggle",""),c.attr("data-target",""),c.toggleClass("deletable"),c.toggleClass("wire-label-success"),c.toggleClass("wire-label-default")}}}}]),app.directive("tabSwitch",[function(){"use strict";return{replace:!0,scope:{consult:"=",idx:"@"},template:'<li><a class="tab-switch" href="#{{consult.consult_date}}-{{idx}}" role="tab" data-toggle="tab">{{getDateLabel(consult.consult_date, true)}}</a></li>',link:function(a,b){a.getDateLabel=a.$parent.getDateLabel,$(b).click(function(a){a.preventDefault(),$(this).tab("show")})}}}]),app.directive("todayTabSwitch",[function(){"use strict";return{replace:!0,scope:{consult:"="},template:'<li class="active"><a class="tab-switch" href="#today" role="tab" data-toggle="tab">Hoy</a></li>',link:function(a,b){a.getDateLabel=a.$parent.getDateLabel,$(b).click(function(a){a.preventDefault(),$(this).tab("show")})}}}]);var app=angular.module("CEDEK"),serviceEndpoint="https://cedek-cultome.c9.io";app.factory("PeopleService",["$resource","AuthService",function(a,b){"use strict";var c=a(serviceEndpoint+"/people/:personId",{personId:"@id"},{update:{method:"PUT"}}),d=a(serviceEndpoint+"/courses/:courseId/:action/:actionId",{courseId:"@courseId",action:"@action",actionId:"@actionId"});return{updateStudent:function(a,d,e,f){var g=angular.copy(d);delete g.id,delete g.debts,delete g.previous,delete g.reserves,delete g.enrollments,delete g.scholarships,delete g.marital_status_name;var h=b.getToken();return c.update({personId:a,t:h},g,e,f)},createStudent:function(a,d,e){var f=b.getToken();return c.save({t:f},a,d,e)},listStudents:function(a,b){return c.query({},a,b)},getStudentsFromCourse:function(a,b,c){return d.query({courseId:a,action:"students"},b,c)},getCourseStudent:function(a,b,c,e){return d.get({courseId:a,action:"students",actionId:b},c,e)},getStudent:function(a,b,d){return c.get({personId:a},b,d)},getCourseDebts:function(a,b,c){return d.query({courseId:a,action:"debts"},b,c)},getCourseScholarships:function(a,b,c){return d.query({courseId:a,action:"scholarships"},b,c)},birthdaysToday:function(a,b){return c.query({birthday:"today"},a,b)}}}]),app.factory("CourseService",["$resource","AuthService",function(a,b){"use strict";var c=a(serviceEndpoint+"/courses/:courseId/:action/:actionId",{courseId:"@courseId",action:"@action",actionId:"@actionId"},{update:{method:"PUT"}});return{unrollStudent:function(a,d,e,f){var g=b.getToken();return c["delete"]({courseId:a,action:"unroll",actionId:d,t:g},e,f)},giveScholarship:function(a,d,e,f,g){var h=b.getToken();return c.save({courseId:a,action:"scholarship",actionId:d,amount:e,t:h},f,g)},subscribeStudent:function(a,d,e,f){var g=b.getToken();return c.save({courseId:a,action:"subscribe",actionId:d,t:g},e,f)},checkAttendance:function(a,d,e,f,g){var h=b.getToken();return c.save({courseId:a,action:"attendance",actionId:d,sessionDate:e,t:h},f,g)},createCourse:function(a,d,e){var f=b.getToken();return c.save({t:f},a,d,e)},updateCourse:function(a,d,e,f){var g=angular.copy(d);delete g.scholarships,delete g.students,delete g.beginLabel,delete g.endLabel,delete g.id,delete g.schedule;var h=b.getToken();return c.update({courseId:a,t:h},g,e,f)},getCourse:function(a,b,d){return c.get({courseId:a},b,d)},getCourseSessions:function(a,b,d){return c.query({courseId:a,action:"sessions"},b,d)},getCourses:function(a,b){return c.query({},a,b)},getComingCourses:function(a,b){return c.query({coming:!0},a,b)},getTodayCourses:function(a,b){return c.query({today:!0},a,b)},getActiveCourses:function(a,b){return c.query({active:!0},a,b)},getOpenCourses:function(){return c.query({open:!0})},getAttendance:function(a,b,d,e){return c.query({courseId:a,action:"attendance",date:b},d,e)}}}]),app.factory("ScholarshipService",["$resource","AuthService",function(a,b){"use strict";var c=a(serviceEndpoint+"/scholarship/:scholarshipId",{scholarshipId:"@id"});return{revoke:function(a,d,e){var f=b.getToken();return c["delete"]({scholarshipId:a,t:f},d,e)}}}]),app.factory("DebtService",["$resource","AuthService",function(a,b){"use strict";var c=a(serviceEndpoint+"/debts/:action/:actionId",{action:"@action"});return{makePayment:function(a,b,d,e,f,g){return c.save({studentId:a,courseId:b,payment:d,amount:e,action:"pay"},f,g)},payLater:function(a,b,d,e,f,g,h){var i="true"===e;return c.save({studentId:a,courseId:b,date:f,charge:i,amount:d,action:"later"},g,h)},payNow:function(a,d,e){var f=b.getToken();return c["delete"]({actionId:a,action:"remove",t:f},d,e)}}}]),app.factory("CatalogService",["$resource",function(a){"use strict";var b=a(serviceEndpoint+"/catalogs/:catalogId",{catalogId:"@id"});return{phonesCache:null,leadersCache:null,maritalStatusCache:null,userTypesCache:null,phoneTypes:function(a,c){return null===this.phonesCache&&(this.phonesCache=b.query({catalogId:"phone"},a,c)),this.phonesCache},maritalStatus:function(a,c){return null===this.maritalStatusCache&&(this.maritalStatusCache=b.query({catalogId:"maritalStatus"},a,c)),this.maritalStatusCache},leaders:function(a,c){return null===this.leadersCache&&(this.leadersCache=b.query({catalogId:"leaders"},a,c)),this.leadersCache},userTypes:function(a,c){return null===this.userTypesCache&&(this.userTypesCache=b.query({catalogId:"userType"},a,c)),this.userTypesCache}}}]),app.factory("UserService",["$resource","AuthService",function(a,b){"use strict";var c=a(serviceEndpoint+"/users/:userId",{userId:"@id"},{update:{method:"PUT"}});return{create:function(a,d,e){var f=b.getToken();return c.save({t:f},a,d,e)},update:function(a,d,e,f){var g=b.getToken();return c.update({userId:a,t:g},d,e,f)},get:function(a,b,d){return c.get({userId:a},b,d)},getUsers:function(a,b){return c.query({},a,b)}}}]),app.factory("ConsultService",["$resource","AuthService",function(a,b){"use strict";var c=a(serviceEndpoint+"/consults/:personId",{personId:"@id"}),d={};return{cleanPacientConsult:function(a){return d[a]||(d[a]={}),d[a].consult_date=null,d[a].reason=null,d[a].diagnostic=null,d[a].treatment=null,d[a].leader_id=null,d[a].person_id=null,d[a].drops={bl:!1,rj:!1,vr:!1,rs:!1,am:!1},d[a]},getCurrentConsult:function(a,b){return d[a]||this.cleanPacientConsult(a),d[a].person_id=a,d[a].consult_date=b,d[a]},save:function(a,d,e,f){var g=b.getToken();return c.save({personId:d,t:g},a,e,f)},getLastConsults:function(a,b,d){return c.query({personId:a,recent:!0},b,d)},getAllConsults:function(a,b,d){return c.query({personId:a},b,d)}}}]),app.factory("AuthService",["$resource",function(a){"use strict";var b=a(serviceEndpoint+"/auth/:userId",{userId:"@id"},{update:{method:"PUT"}});return{currentUser:null,login:function(a,c,d,e){return this.currentUser=b.save({},{username:a,password:c},d,e),this.currentUser},changePassword:function(a,c,d,e,f){return b.update({userId:a,t:this.getToken()},{currentPassword:c,newPassword:d},e,f)},getCurrentUser:function(){return this.currentUser},getToken:function(){if(null===this.currentUser)throw"El usuario no esta firmado en el sistema.";return this.currentUser.token}}}]),app.factory("AdminService",["$resource","AuthService",function(a,b){"use strict";var c=a(serviceEndpoint+"/admin/:actionId",{actionId:"@actionId"});return{getEvents:function(a,d,e,f){var g=b.getToken();return c.query({m:d,p:a,actionId:"events",t:g},e,f)}}}]),app.factory("PagerService",["$resource",function(a){"use strict";var b=a(serviceEndpoint+"/pager/:actionId",{actionId:"@actionId"});return{getEventsCount:function(a,c){return b.get({actionId:"events"},a,c)}}}]);